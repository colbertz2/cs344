#!/bin/bash

#######################################################
# TITLE: matrix                                       #
# AUTHOR: Zach Colbert                                #
# EMAIL: colbertz@oregonstate.edu                     #
# DESCRIPTION: Tools for manipulating and calulating  #
#              statistics on integer matrices.        #
# NOTES: CS 344, W 2020 (online)                      #
#######################################################

####################
# GLOBAL VARIABLES #
####################

# Global return value of functions
_RET=0

########################
# FUNCTION DEFINITIONS #
########################

# Test function prints stuff to console
test() {
  echo "Hello, world!"
  exit 0
}

# Alias for usage()
help() {
  _usage
}

# Prints usage info to console (when you've fucked up)
_usage() {
  echo -e "Usage: $0 \033[4mOPERATION\033[0m [\033[4mARGUMENT\033[0m] ..." 1>&2
  echo -e "\nPossible operations are:" 1>&2
  echo -e "  dims \t\tPrint the dimensions of the matrix (rows cols)" 1>&2
  echo -e "  transpose \tTranspose matrix elements" 1>&2
  echo -e "  mean \t\tColumn-wise mean of matrix elements" 1>&2
  echo -e "  add \t\tAdd two m x n matrices" 1>&2
  echo -e "  multiply \tMultiply an (m x n) and a (n x p) matrix" 1>&2
  echo -e "  test \t\tPrints 'Hello, world!'" 1>&2
  echo -e "  help \t\tPrints this message" 1>&2
  echo 1>&2
  exit 1
}

_usage_dims() {
  echo -e "Usage: $0 $1 [\033[4mMATRIX\033[0m]" 1>&2
  echo 1>&2
  exit 1
}

_usage_transpose() {
  # Same as _usage_dims
  _usage_dims $1
}

# Check if file exists, print an error if it doesn't
_fileExists() {
  if [ ! -f $1 ]; then
    echo "$1: No such file" 1>&2
    echo 1>&2
    exit 1
  fi
}

# Check if file is readable
_fileIsReadable() {
  if [ ! -r $1 ]; then
    echo "$1: File is unreadable" 1>&2
    echo 1>&2
    exit 1
  fi
}

# Count the rows in a matrix file
_countRows() {
  # Init counter
  i=0

  # Loop reading all lines in file $1
  while read line; do
    ((i++))
  done < $1

  _RET=$i
}

# Count the columns in the first row of file $1
_countCols() {
  # Init counter
  i=0

  # Read a single line from the top of the file
  read line < $1

  # Loop through each element of the line
  for el in $line; do
    ((i++))
  done

  _RET=$i
}

# Returns dimensions of the given matrix (rows cols)
dims() {
  tmp="$$.tmp"
  trap "rm -f $tmp; echo 'Signal trap: Cleaning up and exiting' 1>&2; exit 1" INT HUP TERM
  
  # Inspired by:
  # https://superuser.com/questions/747884/how-to-write-a-script-that-accepts-input-from-a-file-or-from-stdin
  [ $# -ge 1 ] && _fileExists "$1" && _fileIsReadable "$1" && cat $1 > $tmp || cat - > $tmp

  _countRows $tmp
  printf "$_RET "

  _countCols $tmp
  printf "$_RET\n"

  rm -f $tmp

  exit 0
}

# Transposes a given matrix along the diagonal
transpose() {
  infile="$$-in.tmp"
  temp="$$.tmp"
  tempCol="$$-col.tmp"
  trap "rm -f $infile $temp $tempCol; echo 'Signal trap: Cleaning up and exiting' 1>&2; exit 1" INT HUP TERM
  [ $# -ge 1 ] && _fileExists "$1" && _fileIsReadable "$1" && cat $1 > $infile || cat - > $infile

  # Get matrix dimensions
  _countRows $infile
  inRows=$_RET

  _countCols $infile
  inCols=$_RET
  
  for c in `seq 1 $inCols`; do
    # Cut the column and save it to temp file
    cut -s -f $c $infile > $tempCol

    # Write each element in column to a tab-delim row in temp file
    count=1
    while read el; do
      printf "$el" >> $temp
      if [ $count -lt $inRows ]; then
        printf "\t" >> $temp
      fi
      count=`expr $count + 1`
    done < $tempCol

    # Newline at end of each row
    printf "\n" >> $temp
  done

  # echo new matrix
  cat -A $temp

  # Clean up
  rm -f $infile $temp $tempCol
  exit 0
}

# Returns the column-wise mean of a given matrix as a row vector
mean() {
  infile="$$-in.tmp"
  temp="$$.tmp"
  outfile="$$-out.tmp"
  trap "rm -f $infile $temp $outfile; echo 'Signal trap: Cleaning up and exiting' 1>&2; exit 1" INT HUP TERM
  [ $# -ge 1 ] && _fileExists "$1" && _fileIsReadable "$1" && cat $1 > $infile || cat - > $infile

  # Get matrix dimensions
  _countRows $infile
  inr=$_RET

  _countCols $infile
  inc=$_RET

  for c in `seq 1 $inc`; do
    # Cut the column and save it to temp file
    cut -s -f $c $infile > $temp

    # Sum all the elements of the column
    sum=0
    count=0
    while read el; do
      echo $el
      sum=`expr $sum + $el`
      count=`expr $count + 1`
    done < $temp
    
    echo "Sum: $sum"
    echo "Count: $count"

    # Divide by number of elements 
    avg=`expr \( $sum + \( $count / 2 \) \* \( \( $sum \> 0 \) \* 2 - 1 \) \) / $count`

    # Write result to temp file
    echo $avg >> $outfile
  done

  # Transpose results from temp file to a row
  count=1
  while read el; do
    printf "$el"
    if [ $count -lt $inc ]; then
      printf "\t"
    fi
    count=`expr $count + 1`
  done < $outfile
  printf "\n"

  # Clean up
  rm -f $infile $temp $outfile
  exit 0
}


################
# MAIN ROUTINE #
################

# If no operation is provided, print usage info
if [ $# -eq 0 ]; then
  _usage
fi

# Runs the function passed in $1 with remaining arguments
$1 "${@:2}"

